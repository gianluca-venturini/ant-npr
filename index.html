<html>
	<head>
		<title>My first Three.js app</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
		<script type="x-shader/x-vertex" id="antVertexShader">
			varying vec2 vUv;

			void main() {
				vUv = uv;

				gl_Position = vec4(position,1.0);
			}
		</script>

		<script type="x-shader/x-fragment" id="antFragmentShader">
			uniform sampler2D antTexture;

			varying vec2 vUv;

			void main() {
				vec2 p = vUv;
				gl_FragColor = texture2D(antTexture, p); // Displays Nothing
				//gl_FragColor = vec4(0.5, 0.2, 1.0, 1.0); // Works; Displays Flat Color
			}
		</script>

		<script type="x-shader/x-vertex" id="livingVertexShader">
			varying vec2 vUv;

			void main() {
				vUv = uv;

				gl_Position = vec4(position,1.0);
			}
		</script>

		<script type="x-shader/x-fragment" id="livingFragmentShader">
			uniform sampler2D livingTexture;

			varying vec2 vUv;

			void main() {
				vec2 p = vUv;
				gl_FragColor = texture2D(livingTexture, p) + vec4(0.7, 0, 0, 0); // Displays Nothing
				//gl_FragColor = vec4(0.5, 0.2, 1.0, 1.0); // Works; Displays Flat Color
			}
		</script>

		<script type="x-shader/x-vertex" id="paintingVertexShader">
			varying vec2 vUv;

			void main() {
				vUv = uv;

				gl_Position = vec4(position,1.0);
			}
		</script>

		<script type="x-shader/x-fragment" id="paintingFragmentShader">
			uniform sampler2D paintingTexture;

			varying vec2 vUv;

			void main() {
				vec2 p = vUv;
				gl_FragColor = texture2D(paintingTexture, p); // Displays Nothing
				//gl_FragColor = vec4(0.5, 0.2, 1.0, 1.0); // Works; Displays Flat Color
			}
		</script>

		<script type="x-shader/x-vertex" id="finalVertexShader">
			varying vec2 vUv;

			void main() {
				vUv = uv;

				gl_Position = vec4(position,1.0);
			}
		</script>

		<script type="x-shader/x-fragment" id="finalFragmentShader">
			uniform sampler2D paintingTexture;

			varying vec2 vUv;

			void main() {
				vec2 p = vUv;
				gl_FragColor = texture2D(paintingTexture, p); // Displays Nothing
				//gl_FragColor = vec4(0.5, 0.2, 1.0, 1.0); // Works; Displays Flat Color
			}
		</script>
	</head>
	<body>
		<script src="js/three.min.js"></script>
		<script>
			var camera;

			var renderer;

			// Meshes
			var paintingMesh;
			var livingMesh;
			var antMesh;
			var finalMesh;

			// Textures
			var painting;
			var living;
			var ant;

			// Scenes
			var paintingScene;
			var livingScene;
			var antScene;
			var finalScene;

			// Uniforms
			var paintingUniforms;
			var livingUniforms;
			var antUniforms;
			var finalUniforms;
			 
			init();
			animate();

			function init() {

				// Scenes
				paintingScene = new THREE.Scene();
				livingScene   = new THREE.Scene();
				antScene      = new THREE.Scene();
				finalScene    = new THREE.Scene();

				// Use only this camera
			    camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000);
				camera.position.z = 1;

				paintingScene.add(camera);
				livingScene.add(camera);
				antScene.add(camera);
				finalScene.add(camera);

				// Create textures
				painting = THREE.ImageUtils.loadTexture("image/sea.jpg", {}, function() {painting["loaded"] = true;});
				living = THREE.ImageUtils.loadTexture("image/sea.jpg", {}, function() {living["loaded"] = true;});
				ant = THREE.ImageUtils.loadTexture("image/sea.jpg", {}, function() {ant["loaded"] = true;});

				//painting.onLoad = ;

				var height = 2;
				var width  = 2;

				// Create uniforms
				paintingUniforms = {
					paintingTexture: { type: "t", value: painting }
				};

				livingUniforms = {
					livingTexture: { type: "t", value: living }
				};

				antUniforms = {
					antTexture: { type: "t", value: ant }
				};

				finalUniforms = {
					paintingTexture: { type: "t", value: painting }
				};

				// Create Shaders
				var livingVertexShader     = document.getElementById('livingVertexShader').innerHTML;
				var livingFragmentShader   = document.getElementById('livingFragmentShader').innerHTML;

				var paintingVertexShader   = document.getElementById('paintingVertexShader').innerHTML;
				var paintingFragmentShader = document.getElementById('paintingFragmentShader').innerHTML;

				var antVertexShader        = document.getElementById('antVertexShader').innerHTML;
				var antFragmentShader      = document.getElementById('antFragmentShader').innerHTML;

				var finalVertexShader        = document.getElementById('finalVertexShader').innerHTML;
				var finalFragmentShader      = document.getElementById('finalFragmentShader').innerHTML;

				var paintingMaterial = new THREE.ShaderMaterial({
					uniforms: paintingUniforms,
					vertexShader: paintingVertexShader,
					fragmentShader: paintingFragmentShader
				});

				var livingMaterial = new THREE.ShaderMaterial({
					uniforms: livingUniforms,
					vertexShader: livingVertexShader,
					fragmentShader: livingFragmentShader
				});

				var antMaterial = new THREE.ShaderMaterial({
					uniforms: antUniforms,
					vertexShader: antVertexShader,
					fragmentShader: antFragmentShader
				});

				var finalMaterial = new THREE.ShaderMaterial({
					uniforms: finalUniforms,
					vertexShader: finalVertexShader,
					fragmentShader: finalFragmentShader
				});


			    paintingMesh = new THREE.Mesh(
						new THREE.PlaneGeometry(width, height, 0),
						paintingMaterial
				);

				livingMesh = new THREE.Mesh(
						new THREE.PlaneGeometry(width, height, 0),
						livingMaterial
				);

				antMesh = new THREE.Mesh(
						new THREE.PlaneGeometry(width, height, 0),
						antMaterial
				);

				finalMesh = new THREE.Mesh(
						new THREE.PlaneGeometry(width, height, 0),
						finalMaterial
				);

				paintingMesh.material.depthTest = false;
				paintingMesh.material.depthWrite = false;

				livingMesh.material.depthTest = false;
				livingMesh.material.depthWrite = false;

				antMesh.material.depthTest = false;
				antMesh.material.depthWrite = false;

				finalMesh.material.depthTest = false;
				finalMesh.material.depthWrite = false;

				paintingScene.add(paintingMesh);
				livingScene.add(livingMesh);
				antScene.add(antMesh);
				finalScene.add(finalMesh);
			 
			    renderer = new THREE.WebGLRenderer();
			    renderer.setSize( window.innerWidth, window.innerHeight );
			    document.body.appendChild( renderer.domElement );
			 
			    window.addEventListener( 'resize', onWindowResize, false );
			 
			    //render();

				//requestAnimationFrame( animate );
			}
			 

			function animate() {
				if(ant["loaded"] == true &&
				   living["loaded"] == true &&
				   painting["loaded"] == true)
					render();

			    requestAnimationFrame( animate );
			}
			 
			function render() {
				renderer.autoClear = false;
				renderer.clear();

				/*
				// Update ants
			    renderer.render( antScene, camera, ant, true);

				// Update living
				renderer.render( livingScene, camera, living, true);
				*/

				// Update painting
				renderer.render( paintingScene, camera, painting, true);


				// Draw painting on the screen
				renderer.render( finalScene, camera);
			}
			 
			function onWindowResize() {
			    camera.aspect = window.innerWidth / window.innerHeight;
			    camera.updateProjectionMatrix();
			    renderer.setSize( window.innerWidth, window.innerHeight );
			    render();
			}
		</script>
	</body>
</html>